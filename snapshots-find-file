#!/bin/bash
SCRIPT_DIR="$(dirname "${BASH_SOURCE[0]}")"
source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/zfs-search.sh"
source "$SCRIPT_DIR/lib/zfs-compare.sh"
source "$SCRIPT_DIR/lib/zfs-cleanup.sh"

set +f
parse_arguments "$@"
/bin/date
initialize_search_parameters

[[ $VERBOSE ]] && echo && echo -e "Gathering file inventory from snapshots based on search pattern: (${RED}$FILESTR${NC})"

for dataset in ${DATASETS[@]}; do
  process_snapshots_for_dataset "$dataset"
done

if [[ $COMPARE == 1 ]]; then
  compare_snapshot_files_to_live_dataset "$all_snapshot_files_found_tmp" "$DATASETPATH" "${DATASETS[@]}"
  log_snapshot_deltas "$DATASETPATH" "${DATASETS[@]}"
  identify_and_suggest_deletion_candidates "$DATASETPATH" "${DATASETS[@]}"
  echo -e "${BLUE}Comparison process complete. Exiting.${NC}"
  exit 0
fi

rm -f "$all_snapshot_files_found_tmp"
echo ...completed.
