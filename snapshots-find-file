#!/bin/bash

SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

source "$SCRIPT_DIR/lib/common.sh"
source "$SCRIPT_DIR/lib/zfs-search.sh"
source "$SCRIPT_DIR/lib/zfs-compare.sh"
source "$SCRIPT_DIR/lib/zfs-cleanup.sh"

set +f
parse_arguments "$@"
/bin/date
initialize_search_parameters

[[ $VERBOSE ]] && echo && echo -e "Gathering file inventory from snapshots based on search pattern: (${RED}$FILESTR${NC})"

if [[ ${#DATASETS[@]} -eq 0 ]]; then
  echo -e "${YELLOW}No datasets found. Did you mean to include child datasets? Use the -r flag for recursive search.${NC}"
  exit 1
fi

for dataset in "${DATASETS[@]}"; do
  process_snapshots_for_dataset "$dataset"
done

if [[ $COMPARE == 1 ]]; then
  # shellcheck disable=SC2154
  compare_snapshot_files_to_live_dataset "$all_snapshot_files_found_tmp" "$DATASETPATH_FS" "${DATASETS[@]}"
  log_snapshot_deltas "$DATASETPATH_FS" "${DATASETS[@]}"
  # Note: Do not automatically suggest snapshot deletions during compare/search
  # unless explicitly requested via --clean-snapshots or --destroy-snapshots.
  echo -e "${BLUE}Comparison process complete.${NC}"

  # If user requested deletion orchestration, run the cleanup flow now.
  if [[ ${SFF_DELETE_PLAN:-0} -eq 1 || ${DESTROY_SNAPSHOTS:-0} -eq 1 ]]; then
    # Call cleanup orchestration for the same dataset path. If --destroy-snapshots
    # was passed, `identify_and_suggest_deletion_candidates` will attempt to execute
    # the generated plan after prompting the user.
    identify_and_suggest_deletion_candidates "$DATASETPATH_FS" "${DATASETS[@]}"
  fi

  # Print the human-readable comparison summary last (flat bottom of output)
  tmp_base="${LOG_DIR:-${TMPDIR:-/tmp}}"
  summary_csv="$tmp_base/comparison-summary-$TIMESTAMP.csv"
  if [[ -f "$summary_csv" ]]; then
    echo ""
    echo "--- Comparison Summary ---"
    awk -F, 'NR>1 { if($1=="total_snapshot_entries") print "Total snapshot entries processed: "$2; else if($1=="ignored_entries") print "Total ignored entries: "$2; else if($1=="found_in_live") print "Total found in live dataset: "$2; else if($1=="missing") print "Total missing (snapshot-only): "$2; else if($1=="skipped_duplicates") print "Total skipped (duplicates): "$2 }' "$summary_csv"
    echo "Wrote summary to: $summary_csv"
  fi

  echo -e "${BLUE}Exiting.${NC}"
  exit 0
fi

# Notify the user if no files were found
if [[ ! -s "$all_snapshot_files_found_tmp" ]]; then
  echo -e "${YELLOW}No files found matching the specified criteria in the dataset(s).${NC}"
fi

rm -f "$all_snapshot_files_found_tmp"
echo ...completed.